import { Agent as HttpAgent, request as httpRequest } from "http";
import { Agent as HttpsAgent, request as httpsRequest } from "https";
import { parse as parseUrl } from "url";
import { joinPath } from "./joinPath";
export const isBrowser = false;
export function createRequest(baseUrl, agentOptions, agent) {
    const baseUrlParts = parseUrl(baseUrl);
    const isTls = baseUrlParts.protocol === "https:";
    if (!agent) {
        if (isTls)
            agent = new HttpsAgent(agentOptions);
        else
            agent = new HttpAgent(agentOptions);
    }
    return function request({ method, url, headers, body, expectBinary = false }, cb) {
        let path = baseUrlParts.pathname
            ? url.pathname
                ? joinPath(baseUrlParts.pathname, url.pathname)
                : baseUrlParts.pathname
            : url.pathname;
        const search = url.search
            ? baseUrlParts.search
                ? `${baseUrlParts.search}&${url.search.slice(1)}`
                : url.search
            : baseUrlParts.search;
        if (search)
            path += search;
        const options = { path, method, headers, agent };
        options.hostname = baseUrlParts.hostname;
        options.port = baseUrlParts.port;
        options.auth = baseUrlParts.auth;
        let callback = (err, res) => {
            callback = () => undefined;
            cb(err, res);
        };
        const req = (isTls ? httpsRequest : httpRequest)(options, (res) => {
            const data = [];
            res.on("data", chunk => data.push(chunk));
            res.on("end", () => {
                const result = res;
                result.body = Buffer.concat(data);
                if (!expectBinary) {
                    result.body = result.body.toString("utf-8");
                }
                callback(null, result);
            });
        });
        req.on("error", err => {
            const error = err;
            error.request = req;
            callback(error);
        });
        if (body)
            req.write(body);
        req.end();
    };
}
//# sourceMappingURL=request.node.js.map